# KPIデータベース データ移行スクリプト

このスクリプトは、複数のPostgreSQLデータベースから中央のMySQLデータベースへ支払いデータを移行するために設計されたJavaプログラムをTypeScriptに変換したものです。

## プロジェクト構造

```
kpi_database/
├── dist/                     # コンパイルされたJavaScriptファイル (tscの出力)
├── node_modules/             # プロジェクトの依存関係 (npm install により作成)
├── src/                      # TypeScriptソースファイル
│   ├── db.ts                 # データベース接続ヘルパー
│   ├── dateUtils.ts          # 日付操作ユーティリティ関数
│   └── main.ts               # メインスクリプトのロジック
├── .gitignore                # Gitが無視するべき意図的に追跡されないファイルを指定
├── package.json              # プロジェクトのメタデータと依存関係
├── package-lock.json         # 依存関係の正確なバージョンを記録
└── tsconfig.json             # TypeScriptコンパイラオプション
```

## 前提条件

-   Node.js (v14.x 以降を推奨)
-   npm (通常Node.jsに付属)
-   移行元PostgreSQLデータベースへのアクセス権
-   移行先MySQLデータベースへのアクセス権

## セットアップ

1.  **リポジトリをクローンする (該当する場合) か、すべてのファイルが `kpi_database` ディレクトリにあることを確認してください。**

2.  **プロジェクトディレクトリに移動します:**
    ```bash
    cd kpi_database
    ```

3.  **依存関係をインストールします:**
    `pg` (PostgreSQL用)、`mysql2` (MySQL用)、および `typescript` パッケージが必要です。
    ```bash
    npm install
    ```
    *(注意: 自動生成環境の制限により、`node_modules` が事前にインストールされていない可能性があります。このステップは非常に重要です。)*

4.  **データベース接続を設定します:**
    `src/main.ts` を開き、データベース接続設定を更新します:
    -   `mySqlConfig`: ご自身のMySQLサーバー詳細 (ホスト、ユーザー、パスワード、データベース、ポート) に更新してください。
    -   `postgresConfigs`: 各PostgreSQL移行元データベースの接続詳細で配列を更新してください。

    **セキュリティに関する注意:** データベースのパスワードのような機密情報は、ソースファイルに直接ハードコーディングするのではなく、環境変数や設定管理システムを使用することを強く推奨します。

## プロジェクトのビルド

TypeScriptコードをJavaScriptにコンパイルするには、以下を実行します:

```bash
npm run build
```
これにより、`tsc` (TypeScriptコンパイラ) と `tsconfig.json` の設定が使用され、`dist` ディレクトリにJavaScriptファイルが生成されます。

## スクリプトの実行

プロジェクトをビルドした後、以下のコマンドで移行スクリプトを実行できます:

```bash
npm start
```
このコマンドは、コンパイルされた `dist/main.js` ファイルをNode.jsで実行します。

スクリプトは以下の処理を行います:
1.  移行先のMySQLデータベースに接続します。
2.  データ取得を開始する日付を決定します (`stat_product_success` の最終 `insert_date` に基づくか、デフォルトの開始日を使用)。
3.  設定された各PostgreSQL移行元に対して反復処理を行います:
    a.  PostgreSQLデータベースに接続します。
    b.  計算された日付範囲内の支払いデータを取得します。
    c.  取得したデータをMySQLデータベースの `stat_product_success` テーブルに挿入します。
4.  進捗状況とエラーをコンソールに記録します。

## エラーハンドリング

-   個別のPostgreSQLチャネル処理中のエラーはコンソールに記録されますが、スクリプトは他のチャネルの処理を続行しようとします。
-   致命的なエラー (例: MySQLデータベースへの接続不可) はスクリプトを終了させます。
-   すべてのデータベース接続は、エラーが発生した場合でも正常に閉じられることを意図しています。

## 開発

-   ソースコードは `src` ディレクトリにあります。
-   `.ts` ファイルに変更を加えた後、`npm start` を実行して効果を確認する前に、`npm run build` を使用してプロジェクトを再ビルドする必要があります。
-   TypeScriptをグローバルにインストールする (`npm install -g typescript`) か、`node_modules` にインストールされたバージョンを `npx tsc` 経由で使用できます。
```
